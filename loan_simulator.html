<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BTC Loan Opportunity Simulator</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 1em; }
    input, button { padding: 0.5em; margin-top: 5px; width: 100%; }
    pre { background: #f4f4f4; padding: 1em; border-radius: 6px; overflow-x: auto; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    canvas { margin-top: 2em; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<nav>
  <ul>
    <li><a href="index.html">BTC Sell/Buyback Simulator</a></li>
    <li><a href="dca_page.html">DCA Planner</a></li>
    <li><a href="loan_simulator.html">Loan Opportunity Simulator</a></li>
  </ul>
</nav>

<h1>Bitcoin Loan Opportunity Simulator</h1>

<form id="loanSimForm">
  <label>Monthly Loan Installment (BGN): <input type="number" id="monthlyPayment" step="0.01" required></label>
  <label>Remaining Loan Months: <input type="number" id="monthsLeft" required></label>
  <label>Remaining Loan Principal (BGN): <input type="number" id="loanPrincipal" required></label>
  <label>BTC Owned Now: <input type="number" id="btcOwned" step="0.00000001" required></label>
  <label>Interest Rate (% annual, leave 0 if unsure): <input type="number" id="interestRate" step="0.01"></label>
  <label>BTC Price Forecasts (comma-separated in USD): <input type="text" id="btcPrices" placeholder="e.g. 30000,50000,100000,200000" required></label>
  <label>Exchange Rate (USD → BGN): <input type="number" id="usdToBgn" step="0.01" required></label>
  <button type="submit">Simulate</button>
</form>

<pre id="loanSimOutput"></pre>

<canvas id="btcChart" width="800" height="400"></canvas>

<script>
let chart;

document.getElementById("loanSimForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const monthlyPayment = parseFloat(document.getElementById("monthlyPayment").value);
  const monthsLeft = parseInt(document.getElementById("monthsLeft").value);
  const loanPrincipal = parseFloat(document.getElementById("loanPrincipal").value);
  const btcOwned = parseFloat(document.getElementById("btcOwned").value);
  const annualRate = parseFloat(document.getElementById("interestRate").value) || 0;
  const btcPricesUSD = document.getElementById("btcPrices").value.split(",").map(p => parseFloat(p.trim()));
  const usdToBgn = parseFloat(document.getElementById("usdToBgn").value);

  if (btcPricesUSD.some(p => isNaN(p) || p <= 0)) {
    return document.getElementById("loanSimOutput").innerText = "❌ Invalid BTC prices.";
  }

  const totalBGN = monthlyPayment * monthsLeft;
  const totalInterestBGN = annualRate > 0 ? totalBGN * (annualRate / 100) * (monthsLeft / 12) : 0;
  const futureCost = totalBGN + totalInterestBGN;

  let output = `📊 BTC Loan Opportunity Simulation\n\n`;
  output += `Total redirected over ${monthsLeft} months: ${totalBGN.toFixed(2)} BGN\n`;
  if (annualRate > 0) {
    output += `Estimated Interest Paid: ${totalInterestBGN.toFixed(2)} BGN\n`;
    output += `Effective Total Loan Cost: ${futureCost.toFixed(2)} BGN\n`;
  }

  output += `\nBTC Owned: ${btcOwned.toFixed(8)} BTC\nLoan Principal: ${loanPrincipal.toFixed(2)} BGN\n\n`;
  output += `Scenario Results:\n`;
  output += "BTC Price (USD) | BTC to Sell to Repay Loan | BTC After Sell | BTC if DCA Instead | Value in BGN (DCA) | BTC Difference\n";
  output += "----------------|-----------------------------|----------------|--------------------|--------------------|----------------\n";

  const labels = [];
  const btcSellLine = [];
  const btcDcaLine = [];

  btcPricesUSD.forEach(usd => {
    const btcPriceBGN = usd * usdToBgn;
    const btcToSell = loanPrincipal / btcPriceBGN;
    const btcAfterSell = btcOwned - btcToSell;
    const btcFromDCA = totalBGN / btcPriceBGN;
    const valueBGN = btcFromDCA * btcPriceBGN;
    const btcDiff = btcFromDCA - btcAfterSell;

    output += `$${usd.toLocaleString().padEnd(12)} | ${btcToSell.toFixed(8).padEnd(27)} | ${btcAfterSell.toFixed(8).padEnd(14)} | ${btcFromDCA.toFixed(8).padEnd(18)} | ${valueBGN.toFixed(2).padEnd(18)} | ${btcDiff.toFixed(8)}\n`;

    labels.push(`$${usd}`);
    btcSellLine.push(btcAfterSell);
    btcDcaLine.push(btcFromDCA);
  });

  document.getElementById("loanSimOutput").innerText = output;

  // Render Chart
  const ctx = document.getElementById("btcChart").getContext("2d");
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'BTC Remaining After Loan Repayment (🔴)',
          data: btcSellLine,
          borderColor: 'red',
          backgroundColor: 'rgba(255,0,0,0.1)',
          fill: true,
          tension: 0.2
        },
        {
          label: 'BTC if DCA Instead (🟢)',
          data: btcDcaLine,
          borderColor: 'green',
          backgroundColor: 'rgba(0,255,0,0.1)',
          fill: true,
          tension: 0.2
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'BTC Difference: Selling to Repay vs DCA Strategy'
        },
        tooltip: {
          mode: 'index',
          intersect: false,
        }
      },
      interaction: {
        mode: 'nearest',
        axis: 'x',
        intersect: false
      },
      scales: {
        y: {
          title: {
            display: true,
            text: 'BTC Amount'
          }
        },
        x: {
          title: {
            display: true,
            text: 'BTC Price (USD)'
          }
        }
      }
    }
  });
});
</script>

</body>
</html>
